<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Probability Challenge</title>
  <style>
    :root {
      --primary-color: #2c3e50;
      --success-color: #27ae60;
      --danger-color: #e74c3c;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #2c3e50;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-color);
      color: var(--dark-color);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      flex: 1;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
    }

    h1 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .game-area {
      background: white;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .progress-display {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .progress-bar {
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      position: relative;
      flex-grow: 1;
      margin-right: 1rem;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--success-color);
      width: 0%;
      transition: width 0.3s ease;
    }

    .probability-display {
      min-width: 120px;
      text-align: center;
      background-color: var(--primary-color);
      color: white;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 1rem;
      font-weight: bold;
    }

    .level-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .level-step {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .level-step.active {
      background-color: var(--success-color);
      color: white;
    }

    .level-step::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: calc(100% - 30px);
      height: 3px;
      background-color: #e0e0e0;
      z-index: -1;
    }

    .level-step:last-child::after {
      display: none;
    }

    .level-step.active::after {
      background-color: var(--success-color);
    }

    .action-area {
      text-align: center;
      margin-top: 2rem;
    }

    .attempt-btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.8rem 2rem;
      font-size: 1.1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .attempt-btn:hover {
      background-color: #34495e;
      transform: translateY(-2px);
    }

    .attempt-btn:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }

    .status-message {
      margin: 1rem 0;
      min-height: 1.5em;
      font-weight: bold;
      text-align: center;
    }

    .winner-info {
      text-align: center;
      margin-top: 1rem;
      font-style: italic;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    .modal-content {
      background-color: white;
      padding: 2rem;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }

    .modal-title {
      color: var(--success-color);
      margin-top: 0;
    }

    .modal-input {
      width: 100%;
      padding: 0.8rem;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    .modal-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }

    .modal-btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }

    .modal-btn-primary {
      background-color: var(--success-color);
      color: white;
    }

    /* Animation classes */
    .shake {
      animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
      10%, 90% { transform: translateX(-1px); }
      20%, 80% { transform: translateX(2px); }
      30%, 50%, 70% { transform: translateX(-4px); }
      40%, 60% { transform: translateX(4px); }
    }

    .celebrate {
      animation: celebrate 0.5s ease;
    }

    @keyframes celebrate {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Probability Challenge</h1>
      <p>Test your luck through progressively difficult levels</p>
    </header>

    <div class="game-area">
      <div class="progress-display">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="probability-display" id="probabilityDisplay">90%</div>
      </div>

      <div class="level-indicator" id="levelIndicator"></div>

      <div class="status-message" id="statusMessage">Click the button to start your challenge</div>

      <div class="action-area">
        <button class="attempt-btn" id="attemptBtn">Attempt Level</button>
      </div>
    </div>

    <div class="winner-info" id="winnerInfo">Loading last winner...</div>
  </div>

  <!-- Winner Modal -->
  <div class="modal-overlay" id="winnerModal">
    <div class="modal-content">
      <h2 class="modal-title">Challenge Complete!</h2>
      <p>You've beaten all levels against the odds!</p>
      <p>Enter your name to be recorded in the hall of winners:</p>
      <input type="text" class="modal-input" id="winnerNameInput" placeholder="Your name" maxlength="30">
      <div class="modal-actions">
        <button class="modal-btn modal-btn-primary" id="submitWinnerBtn">Submit</button>
      </div>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="winSound" src="trompeta.mp3" preload="auto"></audio>
  <audio id="failSound1" src="offMinecraft.mp3" preload="auto"></audio>
  <audio id="failSound2" src="oofRoblox.mp3" preload="auto"></audio>
  <audio id="failSound3" src="peo.mp3" preload="auto"></audio>
  <audio id="failSound4" src="boomVine.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-functions-compat.js"></script>
  <script src="config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Game state
      const gameState = {
        currentLevel: 0,
        currentProbability: 0.9,
        lastWinner: null,
        sessionId: generateSessionId(),
        attemptCount: 0
      }

      // DOM elements
      const elements = {
        progressFill: document.getElementById('progressFill'),
        probabilityDisplay: document.getElementById('probabilityDisplay'),
        levelIndicator: document.getElementById('levelIndicator'),
        statusMessage: document.getElementById('statusMessage'),
        attemptBtn: document.getElementById('attemptBtn'),
        winnerInfo: document.getElementById('winnerInfo'),
        winnerModal: document.getElementById('winnerModal'),
        winnerNameInput: document.getElementById('winnerNameInput'),
        submitWinnerBtn: document.getElementById('submitWinnerBtn'),
        winSound: document.getElementById('winSound'),
        failSounds: [
          document.getElementById('failSound1'),
          document.getElementById('failSound2'),
          document.getElementById('failSound3'),
          document.getElementById('failSound4')
        ]
      }

      // Initialize Firebase
      let firebaseInitialized = false
      try {
        firebase.initializeApp(firebaseConfig)
        firebaseInitialized = true
        console.log('Firebase initialized successfully')
      } catch (error) {
        console.error('Firebase initialization failed:', error)
        elements.statusMessage.textContent = 'System error - game functionality limited'
        elements.attemptBtn.disabled = true
      }

      const db = firebaseInitialized ? firebase.firestore() : null
      const fbFunctions = firebaseInitialized ? firebase.functions() : null

      // Initialize game UI
      function initGameUI() {
        // Create level indicators
        elements.levelIndicator.innerHTML = ''
        for (let i = 0; i <= 8; i++) {
          const levelStep = document.createElement('div')
          levelStep.className = 'level-step'
          levelStep.textContent = i + 1
          levelStep.id = `level-${i}`
          elements.levelIndicator.appendChild(levelStep)
        }

        updateUI()
        loadLastWinner()
      }

      // Update UI based on game state
      function updateUI() {
        // Update progress bar
        elements.progressFill.style.width = `${gameState.currentProbability * 100}%`
        elements.probabilityDisplay.textContent = `${Math.round(gameState.currentProbability * 100)}%`

        // Update level indicators
        document.querySelectorAll('.level-step').forEach((step, index) => {
          if (index < gameState.currentLevel) {
            step.classList.add('active')
          } else {
            step.classList.remove('active')
          }
        })
      }

      // Generate a unique session ID
      function generateSessionId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          const r = Math.random() * 16 | 0
          const v = c === 'x' ? r : (r & 0x3 | 0x8)
          return v.toString(16)
        })
      }

     // Función auxiliar para generar el clientSeed
function generateClientSeed() {
  return window.crypto.getRandomValues(new Uint32Array(1))[0].toString(36) +
         Date.now().toString(36)
}

      // Handle level attempt
      async function attemptLevel() {
  gameState.attemptCount++;
  elements.attemptBtn.disabled = true;
  elements.statusMessage.textContent = 'Calculating your odds...';

  try {
    // ENVÍA DIRECTAMENTE EL OBJETO currentAttempt SIN EL WRAPPER 'data'
    const attemptData = {
      currentAttempt: {
        level: Number(gameState.currentLevel),
        clientSeed: generateClientSeed()
      }
    };

    console.log('Sending attempt data:', JSON.stringify(attemptData, null, 2));

    // Llama a la función sin wrapper adicional
    const result = await fbFunctions.httpsCallable('attemptLevel')(attemptData);

    console.log('Received response:', result.data);

    // Procesa la respuesta exitosa
    const { success, probability, nextLevel, isMaxLevel } = result.data;

    gameState.currentProbability = probability / 100;
    gameState.currentLevel = nextLevel;

    if (success) {
      if (isMaxLevel) {
        handleLevelCompletion();
      } else {
        handleSuccess();
      }
    } else {
      handleFailure();
    }

    updateUI();

  } catch (error) {
    console.error('Error details:', {
      message: error.message,
      code: error.code,
      details: error.details
    });

    elements.statusMessage.textContent = `Error: ${error.message}`;
  } finally {
    elements.attemptBtn.disabled = false;
  }
}
      // Handle successful attempt
      function handleSuccess() {
        elements.statusMessage.textContent = `Success! Advanced to level ${gameState.currentLevel + 1}`
        elements.statusMessage.style.color = 'var(--success-color)'
        document.getElementById(`level-${gameState.currentLevel - 1}`).classList.add('celebrate')
      }

      // Handle failed attempt
      function handleFailure() {
        elements.statusMessage.textContent = 'Attempt failed! Resetting to level 1.'
        elements.statusMessage.style.color = 'var(--danger-color)'
        elements.levelIndicator.classList.add('shake')

        // Play random fail sound
        const randomSound = elements.failSounds[Math.floor(Math.random() * elements.failSounds.length)]
        randomSound.currentTime = 0
        randomSound.play()

        // Remove shake class after animation
        setTimeout(() => {
          elements.levelIndicator.classList.remove('shake')
        }, 500)
      }

      // Handle level completion (reached max level)
      function handleLevelCompletion() {
        elements.winSound.currentTime = 0
        elements.winSound.play()
        elements.statusMessage.textContent = 'Incredible! You beat all levels!'
        showWinnerModal()
      }

      // Show winner modal
      function showWinnerModal() {
        elements.winnerModal.classList.add('active')
        elements.winnerNameInput.focus()
      }

      // Hide winner modal
      function hideWinnerModal() {
        elements.winnerModal.classList.remove('active')
      }

      // Submit winner name
      async function submitWinner() {
        const playerName = elements.winnerNameInput.value.trim()

        if (playerName.length < 2) {
          alert('Please enter a valid name (at least 2 characters)')
          return
        }

        elements.submitWinnerBtn.disabled = true
        elements.submitWinnerBtn.textContent = 'Submitting...'

        try {
          const result = await fbFunctions.httpsCallable('recordWinner')({
            playerName,
            finalLevel: gameState.currentLevel
          })

          if (result.data.status === 'SUCCESS') {
            hideWinnerModal()
            resetGame()
            loadLastWinner()
          } else {
            throw new Error('Failed to record winner')
          }
        } catch (error) {
          console.error('Error submitting winner:', error)
          alert('Failed to submit your name. Please try again.')
        } finally {
          elements.submitWinnerBtn.disabled = false
          elements.submitWinnerBtn.textContent = 'Submit'
        }
      }

      // Reset game after completion
      function resetGame() {
        gameState.currentLevel = 0
        gameState.currentProbability = 0.9
        gameState.attemptCount = 0
        updateUI()
        elements.statusMessage.textContent = 'Click the button to start a new challenge'
        elements.statusMessage.style.color = ''
      }

      // Load last winner from Firestore
      async function loadLastWinner() {
        if (!db) {
          elements.winnerInfo.textContent = 'Database not available'
          return
        }

        // Primero intenta con la nueva ubicación
        try {
          const newDoc = await db.collection('winners').doc('latest').get()
          if (newDoc.exists) {
            updateWinnerInfo(newDoc)
            return
          }
        } catch (error) {
          console.log('No se encontró winner en nueva ubicación, intentando antigua...')
        }

        // Si falla, intenta con la ubicación antigua
        try {
          const oldDoc = await db.collection('levelCompletion').doc('lastCompletion').get()
          if (oldDoc.exists) {
            // Migrar automáticamente a la nueva estructura
            await migrateOldWinner(oldDoc)
            updateWinnerInfo(oldDoc)
          } else {
            elements.winnerInfo.textContent = 'No winners yet - be the first!'
          }
        } catch (error) {
          console.error('Error loading last winner:', error)
          elements.winnerInfo.textContent = 'Error loading winner information'
        }
      }

      function updateWinnerInfo(doc) {
        const data = doc.data()
        const timestamp = data.timestamp.toDate()
        gameState.lastWinner = {
          name: data.name,
          timestamp
        }
        updateLastWinnerDisplay()
      }

      async function migrateOldWinner(oldDoc) {
        try {
          const data = oldDoc.data()
          await db.collection('winners').doc('latest').set({
            name: data.name,
            timestamp: data.timestamp,
            migrated: true
          })
          console.log('Migrado winner antiguo a nueva estructura')
        } catch (migError) {
          console.error('Error migrando datos antiguos:', migError)
        }
      }

      // Update last winner display with relative time
      function updateLastWinnerDisplay() {
        if (!gameState.lastWinner) return

        const { name, timestamp } = gameState.lastWinner
        const relativeTime = getRelativeTime(timestamp)
        elements.winnerInfo.textContent = `Last winner: ${name} (${relativeTime.text})`

        // Update the display when the time unit changes
        if (relativeTime.interval) {
          setTimeout(updateLastWinnerDisplay, relativeTime.interval)
        }
      }

      // Convert date to relative time string
      function getRelativeTime(date) {
        const now = new Date()
        const seconds = Math.floor((now - date) / 1000)

        if (seconds < 60) {
          return {
            text: `${seconds} second${seconds !== 1 ? 's' : ''} ago`,
            interval: 1000
          }
        }

        const minutes = Math.floor(seconds / 60)
        if (minutes < 60) {
          return {
            text: `${minutes} minute${minutes !== 1 ? 's' : ''} ago`,
            interval: 60000
          }
        }

        const hours = Math.floor(minutes / 60)
        if (hours < 24) {
          return {
            text: `${hours} hour${hours !== 1 ? 's' : ''} ago`,
            interval: 3600000
          }
        }

        const days = Math.floor(hours / 24)
        if (days < 30) {
          return {
            text: `${days} day${days !== 1 ? 's' : ''} ago`,
            interval: 86400000
          }
        }

        const months = Math.floor(days / 30)
        if (months < 12) {
          return {
            text: `${months} month${months !== 1 ? 's' : ''} ago`,
            interval: 2592000000
          }
        }

        const years = Math.floor(months / 12)
        return {
          text: `${years} year${years !== 1 ? 's' : ''} ago`,
          interval: 31536000000
        }
      }

      // Event listeners
      elements.attemptBtn.addEventListener('click', attemptLevel)
      elements.submitWinnerBtn.addEventListener('click', submitWinner)
      elements.winnerNameInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') submitWinner()
      })

      // Initialize the game
      initGameUI()
    })
  </script>
</body>
</html>