<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Let's go gambling</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      background-color: #f5f5f5;
      transition: background-color 0.3s;
    }

    #game-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #statusText {
      font-size: 1.3em;
      margin-bottom: 25px;
      min-height: 2em;
    }

    .bar-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 30px;
    }

    .bar-section {
      width: 35px;
      height: 120px;
      background-color: #e0e0e0;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: background-color 0.3s;
      position: relative;
    }

    .bar-section.filled {
      background-color: #4CAF50;
    }

    .bar-section.failed {
      background-color: #f44336 !important;
      transition: background-color 0.1s;
    }

    .bar-section::after {
      content: attr(data-level);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.9em;
      color: #666;
    }

    #tryButton {
      padding: 12px 30px;
      font-size: 1.2em;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #tryButton:hover {
      background-color: #0b7dda;
    }

    #tryButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #lastWin {
      margin-top: 25px;
      font-size: 1em;
      color: #555;
      min-height: 1.5em;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 350px;
      text-align: center;
    }

    .modal h2 {
      margin-top: 0;
      color: #2E7D32;
    }

    .modal input {
      width: 90%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1em;
    }

    .modal button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }

    .modal button:hover {
      background-color: #3e8e41;
    }

    /* Chance indicator */
    #chanceIndicator {
      margin: 15px 0;
      font-size: 1.1em;
      font-weight: bold;
    }

    /* Responsive adjustments */
    @media (max-width: 500px) {
      .bar-section {
        width: 25px;
        height: 90px;
      }
      
      #game-container {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>Let's Go Gambling</h1>
    <div id="statusText">Click the button to start!</div>
    
    <div id="chanceIndicator">Current chance: 90%</div>
    
    <div class="bar-container" id="levelBar">
      <!-- Levels will be added dynamically -->
    </div>
    
    <button id="tryButton">Try Your Luck</button>
    <div id="lastWin">Loading last winner...</div>
  </div>

  <!-- Winner Name Modal -->
  <div id="nameModal" class="modal">
    <div class="modal-content">
      <h2>You Won!</h2>
      <p>Enter your name to be remembered:</p>
      <input type="text" id="playerName" placeholder="Your name" maxlength="30" />
      <button id="submitName">Submit</button>
    </div>
  </div>

  <!-- Audio elements -->
  <audio id="winSound" src="trompeta.mp3" preload="auto"></audio>
  <audio id="fail1" src="offMinecraft.mp3" preload="auto"></audio>
  <audio id="fail2" src="oofRoblox.mp3" preload="auto"></audio>
  <audio id="fail3" src="peo.mp3" preload="auto"></audio>
  <audio id="fail4" src="boomVine.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-functions-compat.js"></script>
  <script src="config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize game state
      let currentLevel = 0;
      let lastWinDate = null;
      let lastWinnerName = "Unknown";
      let updateInterval = null;
      
      // DOM elements
      const levelBar = document.getElementById('levelBar');
      const tryButton = document.getElementById('tryButton');
      const statusText = document.getElementById('statusText');
      const lastWinText = document.getElementById('lastWin');
      const chanceIndicator = document.getElementById('chanceIndicator');
      const nameModal = document.getElementById('nameModal');
      const playerNameInput = document.getElementById('playerName');
      const submitNameBtn = document.getElementById('submitName');
      const body = document.body;
      
      // Audio elements
      const winSound = document.getElementById('winSound');
      const failSounds = [
        document.getElementById('fail1'),
        document.getElementById('fail2'),
        document.getElementById('fail3'),
        document.getElementById('fail4')
      ];
      
      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig);
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Firebase initialization error:", error);
        statusText.textContent = "Error initializing Firebase";
        lastWinText.textContent = "System error";
        return;
      }
      
      const db = firebase.firestore();
      const functions = firebase.functions();
      
      // Create level bars
      function createLevelBars() {
        levelBar.innerHTML = '';
        for (let i = 0; i <= 8; i++) {
          const barSection = document.createElement('div');
          barSection.className = 'bar-section';
          barSection.dataset.level = i + 1;
          levelBar.appendChild(barSection);
        }
      }
      
      // Update the visual level bar
      function updateBar() {
        const bars = document.querySelectorAll('.bar-section');
        bars.forEach((bar, index) => {
          if (index < currentLevel) {
            bar.classList.add('filled');
          } else {
            bar.classList.remove('filled');
          }
        });
      }
      
      // Show name modal when player wins
      function showNameModal() {
        nameModal.style.display = 'flex';
        playerNameInput.focus();
      }
      
      // Hide name modal
      function hideNameModal() {
        nameModal.style.display = 'none';
      }
      
      // Submit winner name to Firebase
      async function submitWinnerName() {
        const playerName = playerNameInput.value.trim();
        
        if (!playerName) {
          alert("Please enter your name");
          return;
        }
        
        try {
          submitNameBtn.disabled = true;
          submitNameBtn.textContent = "Saving...";
          
          await functions.httpsCallable("updateLastWin")({ playerName });
          
          hideNameModal();
          loadLastWin();
          resetGame();
          
        } catch (error) {
          console.error("Error saving winner name:", error);
          alert("Failed to save name. Please try again.");
        } finally {
          submitNameBtn.disabled = false;
          submitNameBtn.textContent = "Submit";
        }
      }
      
      // Reset game after win
      function resetGame() {
        currentLevel = 0;
        updateBar();
        tryButton.disabled = false;
        statusText.textContent = "Click the button to start again!";
        chanceIndicator.textContent = "Current chance: 90%";
      }
      
      // Format relative time (e.g., "2 minutes ago")
      function getRelativeTime(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) {
          return {
            text: `${diffInSeconds} second${diffInSeconds !== 1 ? 's' : ''} ago`,
            interval: 1000
          };
        }
        
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return {
            text: `${diffInMinutes} minute${diffInMinutes !== 1 ? 's' : ''} ago`,
            interval: 60000
          };
        }
        
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return {
            text: `${diffInHours} hour${diffInHours !== 1 ? 's' : ''} ago`,
            interval: 3600000
          };
        }
        
        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays < 30) {
          return {
            text: `${diffInDays} day${diffInDays !== 1 ? 's' : ''} ago`,
            interval: 86400000
          };
        }
        
        const diffInMonths = Math.floor(diffInDays / 30);
        if (diffInMonths < 12) {
          return {
            text: `${diffInMonths} month${diffInMonths !== 1 ? 's' : ''} ago`,
            interval: 2592000000
          };
        }
        
        const diffInYears = Math.floor(diffInMonths / 12);
        return {
          text: `${diffInYears} year${diffInYears !== 1 ? 's' : ''} ago`,
          interval: 31536000000
        };
      }
      
      // Update the last win text
      function updateLastWinText() {
        if (!lastWinDate) {
          lastWinText.textContent = "No winners yet";
          return;
        }
        
        const { text, interval } = getRelativeTime(lastWinDate);
        lastWinText.textContent = `Last winner: ${lastWinnerName} (${text})`;
        
        // Update the interval if needed
        if (!updateInterval || updateInterval.interval !== interval) {
          if (updateInterval) {
            clearInterval(updateInterval.id);
          }
          updateInterval = {
            id: setInterval(updateLastWinText, interval),
            interval: interval
          };
        }
      }
      
      // Load last win from Firestore
      function loadLastWin() {
        db.collection('levelCompletion').doc('lastCompletion').get()
          .then((doc) => {
            if (doc.exists && doc.data().timestamp) {
              lastWinDate = doc.data().timestamp.toDate();
              lastWinnerName = doc.data().name || "Anonymous";
              updateLastWinText();
            } else {
              lastWinText.textContent = "No winners yet";
            }
          })
          .catch((error) => {
            console.error("Error loading last win:", error);
            lastWinText.textContent = "Error loading last winner";
          });
      }
      
      // Handle try button click
      async function handleTryClick() {
        try {
          tryButton.disabled = true;
          statusText.textContent = "Rolling...";
          
          const result = await functions.httpsCallable("tryLevel")({ currentLevel });
          const { success, newLevel, status, nextChance, currentChance } = result.data;
          
          currentLevel = newLevel;
          statusText.textContent = status;
          chanceIndicator.textContent = `Current chance: ${currentChance}%`;
          
          if (success) {
            updateBar();
            
            if (currentLevel > 8) { // Player won
              body.style.backgroundColor = "#4CAF50";
              winSound.currentTime = 0;
              winSound.play();
              showNameModal();
              setTimeout(() => {
                body.style.backgroundColor = "";
              }, 2000);
            }
          } else {
            // Flash red on failure
            const bars = document.querySelectorAll('.bar-section');
            bars.forEach((bar, index) => {
              if (index < currentLevel) {
                bar.classList.add('failed');
              }
            });
            
            // Play random fail sound
            const randomSound = failSounds[Math.floor(Math.random() * failSounds.length)];
            randomSound.currentTime = 0;
            randomSound.play();
            
            // Reset after short delay
            setTimeout(() => {
              bars.forEach(bar => {
                bar.classList.remove('failed');
              });
              currentLevel = 0;
              updateBar();
              chanceIndicator.textContent = `Current chance: 90%`;
            }, 500);
          }
        } catch (error) {
          console.error("Error in tryLevel:", error);
          statusText.textContent = "Error processing your attempt";
        } finally {
          tryButton.disabled = false;
        }
      }
      
      // Event listeners
      tryButton.addEventListener('click', handleTryClick);
      submitNameBtn.addEventListener('click', submitWinnerName);
      playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') submitWinnerName();
      });
      
      // Initialize game
      createLevelBars();
      updateBar();
      loadLastWin();
    });
  </script>
</body>
</html>