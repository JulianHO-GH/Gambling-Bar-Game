<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Probability Gambling</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f5f5f5;
      transition: background-color 0.3s;
    }
    #game-container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #statusText {
      font-size: 1.3em;
      margin: 20px 0;
      min-height: 1.5em;
    }
    .bar-container {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 30px 0;
    }
    .bar-section {
      width: 30px;
      height: 100px;
      background-color: #e0e0e0;
      border-radius: 4px;
      transition: background-color 0.3s;
      position: relative;
    }
    .bar-section.filled {
      background-color: #4CAF50;
    }
    .bar-section.failed {
      background-color: #f44336;
      transition: background-color 0.1s;
    }
    .bar-section::after {
      content: attr(data-level);
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8em;
      color: #666;
    }
    #tryButton {
      padding: 12px 30px;
      font-size: 1.1em;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
    }
    #tryButton:hover {
      background-color: #0b7dda;
    }
    #tryButton:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #probabilityDisplay {
      margin: 15px 0;
      font-size: 1.1em;
    }
    #lastWin {
      margin-top: 20px;
      color: #555;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      width: 90%;
      max-width: 350px;
    }
    .modal h2 {
      color: #2E7D32;
      margin-top: 0;
    }
    .modal input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .modal button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <h1>Probability Gambling</h1>
    <div id="statusText">Click the button to start!</div>
    <div id="probabilityDisplay">Current chance: 90%</div>

    <div class="bar-container" id="levelBar">
      <!-- Levels will be generated by JavaScript -->
    </div>

    <button id="tryButton">Try Your Luck</button>
    <div id="lastWin">Loading last winner...</div>
  </div>

  <!-- Winner Modal -->
  <div id="nameModal" class="modal">
    <div class="modal-content">
      <h2>Congratulations!</h2>
      <p>You beat all levels! Enter your name:</p>
      <input type="text" id="playerName" placeholder="Your name" maxlength="30">
      <button id="submitName">Submit</button>
    </div>
  </div>

  <!-- Audio Elements -->
  <audio id="winSound" src="trompeta.mp3" preload="auto"></audio>
  <audio id="failSound1" src="offMinecraft.mp3" preload="auto"></audio>
  <audio id="failSound2" src="oofRoblox.mp3" preload="auto"></audio>
  <audio id="failSound3" src="peo.mp3" preload="auto"></audio>
  <audio id="failSound4" src="boomVine.mp3" preload="auto"></audio>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-functions-compat.js"></script>
  <script src="config.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Game state
      let currentLevel = 0
      let lastWinDate = null
      let lastWinnerName = "Unknown"
      let updateInterval = null

      // DOM elements
      const levelBar = document.getElementById('levelBar')
      const tryButton = document.getElementById('tryButton')
      const statusText = document.getElementById('statusText')
      const probabilityDisplay = document.getElementById('probabilityDisplay')
      const lastWinText = document.getElementById('lastWin')
      const nameModal = document.getElementById('nameModal')
      const playerNameInput = document.getElementById('playerName')
      const submitNameBtn = document.getElementById('submitName')
      const body = document.body

      // Audio elements
      const winSound = document.getElementById('winSound')
      const failSounds = [
        document.getElementById('failSound1'),
        document.getElementById('failSound2'),
        document.getElementById('failSound3'),
        document.getElementById('failSound4')
      ]

      // Initialize Firebase
      try {
        firebase.initializeApp(firebaseConfig)
        console.log("Firebase initialized successfully")
      } catch (error) {
        console.error("Firebase initialization error:", error)
        statusText.textContent = "Error initializing Firebase"
        return
      }

      const db = firebase.firestore()
      const functions = firebase.functions()

      // Initialize game bars
      function initLevelBars() {
        levelBar.innerHTML = ''
        for (let i = 0; i <= 8; i++) {
          const bar = document.createElement('div')
          bar.className = 'bar-section'
          bar.dataset.level = i + 1
          levelBar.appendChild(bar)
        }
      }

      // Update visual bars based on current level
      function updateBars() {
        const bars = document.querySelectorAll('.bar-section')
        bars.forEach((bar, index) => {
          bar.classList.toggle('filled', index < currentLevel)
        })
      }

      // Show winner modal
      function showWinnerModal() {
        nameModal.style.display = 'flex'
        playerNameInput.focus()
      }

      // Hide winner modal
      function hideWinnerModal() {
        nameModal.style.display = 'none'
      }

      // Submit winner name to server
      async function submitWinner() {
        const name = playerNameInput.value.trim()
        if (!name) {
          alert("Please enter your name")
          return
        }

        try {
          submitNameBtn.disabled = true
          submitNameBtn.textContent = "Saving..."

          await functions.httpsCallable("updateLastWin")({ playerName: name })

          hideWinnerModal()
          loadLastWin()
          resetGame()
        } catch (error) {
          console.error("Error saving winner:", error)
          alert("Failed to save. Please try again.")
        } finally {
          submitNameBtn.disabled = false
          submitNameBtn.textContent = "Submit"
        }
      }

      // Reset game after win
      function resetGame() {
        currentLevel = 0
        updateBars()
        tryButton.disabled = false
        statusText.textContent = "Click the button to start again!"
        probabilityDisplay.textContent = "Current chance: 90%"
      }

      // Format relative time (same as before)
      function formatRelativeTime(date) {
        const now = new Date()
        const seconds = Math.floor((now - date) / 1000)

        if (seconds < 60) return { text: `${seconds} second${seconds !== 1 ? 's' : ''} ago`, interval: 1000 }
        const minutes = Math.floor(seconds / 60)
        if (minutes < 60) return { text: `${minutes} minute${minutes !== 1 ? 's' : ''} ago`, interval: 60000 }
        const hours = Math.floor(minutes / 60)
        if (hours < 24) return { text: `${hours} hour${hours !== 1 ? 's' : ''} ago`, interval: 3600000 }
        const days = Math.floor(hours / 24)
        if (days < 30) return { text: `${days} day${days !== 1 ? 's' : ''} ago`, interval: 86400000 }
        const months = Math.floor(days / 30)
        if (months < 12) return { text: `${months} month${months !== 1 ? 's' : ''} ago`, interval: 2592000000 }
        const years = Math.floor(months / 12)
        return { text: `${years} year${years !== 1 ? 's' : ''} ago`, interval: 31536000000 }
      }

      // Update last win display
      function updateLastWinDisplay() {
        if (!lastWinDate) {
          lastWinText.textContent = "No winners yet"
          return
        }

        const { text, interval } = formatRelativeTime(lastWinDate)
        lastWinText.textContent = `Last winner: ${lastWinnerName} (${text})`

        if (updateInterval) clearInterval(updateInterval)
        updateInterval = setInterval(updateLastWinDisplay, interval)
      }

      // Load last win from Firestore
      function loadLastWin() {
        db.collection('levelCompletion').doc('lastCompletion').get()
          .then(doc => {
            if (doc.exists && doc.data().timestamp) {
              lastWinDate = doc.data().timestamp.toDate()
              lastWinnerName = doc.data().name || "Anonymous"
              updateLastWinDisplay()
            } else {
              lastWinText.textContent = "No winners yet"
            }
          })
          .catch(error => {
            console.error("Error loading last win:", error)
            lastWinText.textContent = "Error loading last winner"
          })
      }

      // Handle try button click
      async function handleTry() {
        try {
          tryButton.disabled = true
          statusText.textContent = "Calculating..."

          // Generate client seed for verification
          const clientSeed = Math.random().toString(36).substring(2, 15)

          const result = await functions.httpsCallable("tryLevel")({
            currentLevel,
            clientSeed
          })

          const { success, newLevel, status, currentChance, nextChance, serverSeed } = result.data

          // Update game state
          currentLevel = newLevel
          statusText.textContent = status
          probabilityDisplay.textContent = `Current chance: ${currentChance}%`

          if (success) {
            updateBars()

            if (currentLevel > 8) { // Player won
              body.style.backgroundColor = "#4CAF50"
              winSound.currentTime = 0
              winSound.play()
              showWinnerModal()
              setTimeout(() => {
                body.style.backgroundColor = ""
              }, 2000)
            }
          } else {
            // Flash red on failure
            const bars = document.querySelectorAll('.bar-section')
            bars.forEach((bar, index) => {
              if (index < currentLevel) bar.classList.add('failed')
            })

            // Play random fail sound
            const randomSound = failSounds[Math.floor(Math.random() * failSounds.length)]
            randomSound.currentTime = 0
            randomSound.play()

            // Reset after delay
            setTimeout(() => {
              bars.forEach(bar => bar.classList.remove('failed'))
              currentLevel = 0
              updateBars()
              probabilityDisplay.textContent = "Current chance: 90%"
            }, 500)
          }

          console.log("Server seed for verification:", serverSeed)
        } catch (error) {
          console.error("Error in tryLevel:", error)
          statusText.textContent = "Error processing your attempt"
        } finally {
          tryButton.disabled = false
        }
      }

      // Event listeners
      tryButton.addEventListener('click', handleTry)
      submitNameBtn.addEventListener('click', submitWinner)
      playerNameInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') submitWinner()
      })

      // Initialize game
      initLevelBars()
      updateBars()
      loadLastWin()
    })
  </script>
</body>
</html>